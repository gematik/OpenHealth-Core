<!--
SPDX-FileCopyrightText: Copyright 2025 gematik GmbH

SPDX-License-Identifier: Apache-2.0

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

*******

For additional notes and disclaimer from gematik and in case of changes by gematik,
find details in the "Readme" file.
-->

# Interoperability with JVM Targets (Java, Kotlin)

This document describes the minimum setup needed to debug JVM processes that call into native code generated by this
project.

## Debugging on macOS

Prerequisites:

- **Unsigned** Java runtime (signed builds will simply not let LLDB attach to the JVM process)
- LLDB installed

Procedure:

1. Launch the JVM application as usual (with or without your standard Java/Kotlin debugger).
2. Before attaching LLDB, export an additional debugserver argument to prevent LLDB from masking signals:

   ```bash
   export LLDB_DEBUGSERVER_EXTRA_ARG_1=--unmask-signals
   ```
3. Attach LLDB to the running JVM process and disable the macOS EXC_BAD_ACCESS trap:

   ```lldb
   settings set platform.plugin.darwin.ignored-exceptions EXC_BAD_ACCESS
   ```

   Background: [https://github.com/llvm/llvm-project/issues/60438](https://github.com/llvm/llvm-project/issues/60438)
4. Continue execution in LLDB and debug normally (breakpoints in native code, stack inspection, etc.).

If LLDB still stops on EXC_BAD_ACCESS immediately after attaching, verify that:

- the environment variable was set in the shell that started LLDB, and
- the JVM build is unsigned.

To make the exception setting persistent, add the following to `~/.lldbinit`:

```lldb
settings set platform.plugin.darwin.ignored-exceptions EXC_BAD_ACCESS
```
